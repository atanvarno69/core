# Atan\Core\Catcher
[PSR-15](http://www.php-fig.org/psr/psr-15/) middleware that catches `Throwable` thrown by later middleware.
* [Catcher::__construct](#__construct)
* [Catcher::process](#process)
* [Catcher::setLogger](#setlogger)
* [Notes](#notes-1)
```php
Catcher implements LoggerAwareInterface, MiddlewareInterface {

    public __construct(
        StreamFactoryInterface $streamFactory,
        ResponseFactoryInterface $responseFactory,
        array $customHandlers = [],
        LoggerInterface $logger = null
    )
    
    public process(
        ServerRequestInterface $request,
        DelegateInterface $delegate
    ): ResponseInterface
    
    public setLogger(
        LoggerInterface $logger
    ): void
}
```

## __construct
Catcher constructor.
```php
__construct(
    StreamFactoryInterface $streamFactory,
    ResponseFactoryInterface $responseFactory,
    array $customHandlers = [],
    LoggerInterface $logger = null
)
```
Requires [PSR-17](http://www.php-fig.org/psr/psr-17/) stream and response factories.

Optionally accepts an array of user defined error handlers. The array key is the `int` error code to handle and the value is a `callable`. Custom handlers must accept a `Throwable` as their only parameter and must return `ResponseInterface`. A caught `Throwable` without a code is treated as if it had code `500`.

Optionally accepts a PSR-3 logger, this enables logging, see [Logging](#logging).

### Parameters
#### streamFactory
`StreamFactoryInterface`: [PSR-17](http://www.php-fig.org/psr/psr-17/) stream factory.

#### responseFactory
`ResponseFactoryInterface`: [PSR-17](http://www.php-fig.org/psr/psr-17/) response factory.

#### customHandlers
`array`: Numeric array of `callable` values. Optional, with default value: `[]`.

#### logger
`LoggerInterface`: [PSR-3](http://www.php-fig.org/psr/psr-3/) logger. Optional, with default value: `null`.

### Throws
`InvalidArgumentException`: [customHandlers](#customhandlers) array is not numerically indexed.
`InvalidArgumentException`: [customHandlers](#customhandlers) array contains non-`callable` values.

### Returns
`Catcher`: on success.

### Notes
#### Custom handlers
The default handler returns a plain text response using the [`ResponseProvider`](https://github.com/atanvarno69/core/blob/master/docs/ResponseProvider.md) `buildErrorResponse()` method, passing it the error code.

If you require more advanced behaviour, you can define custom handlers for specific error codes.

Custom handler callables must implement the following signature:
```php
function(Throwable $caught): ResponseInterface
```
No additional parameters are passed to custom handlers.

The constructor only checks that the **customHandlers** array is indexed numerically and contains `callable` values. It does not check that a custom handler is valid; this is checked when the handler is called by [`process()`](#process).

## process
Middleware method.
```php
process(ServerRequestInterface $request, DelegateInterface $delegate): ResponseInterface
```
Intended to be called by a [PSR-15](http://www.php-fig.org/psr/psr-15/) delegate, and should not be called by users directly.

### Parameters
#### request
`ServerRequestInterface`: [PSR-7](http://www.php-fig.org/psr/psr-7/) server request.

#### delegate
`DelegateInterface`: [PSR-15](http://www.php-fig.org/psr/psr-15/) delegate.

### Throws
None.

### Returns
`ResponseInterface`: If no `Throwable` is thrown by later middleware, the response from the later middleware is returned. Otherwise, an error response is returned by the handler defined for the error code.
  
## setLogger
Sets a logger.
```php
setLogger(LoggerInterface $logger): void
```
Requires a [PSR-3](http://www.php-fig.org/psr/psr-3/) logger. Enables logging, see [Logging](#logging).

### Parameters
#### logger
`LoggerInterface`: [PSR-3](http://www.php-fig.org/psr/psr-3/) logger.

### Throws
None.

### Returns
None.

## Notes
### Logging
If a logger is enabled, `Catcher` will log:
#### `LogLevel::Warning`
A `Throwable` was caught and its handler was called. The log message records the class name of the `Throwable` and its error code. The `'exception'` key of the logger context array contains the caught `Throwable`.
#### `LogLevel::Error`
The custom handler defined for an caught `Throwable` was invalid. `Catcher` fell back to the default handler and returned a generic `500` error. The log message records the error code of the caught `Throwable`. The `'exception'` key of the logger context array contains the `Throwable` thrown from the handler (or the `UnexpectedValueException` generated by `Catcher` when a handler does not return `ResponseInterface`).
